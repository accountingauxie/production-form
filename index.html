<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Production Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
/* --- MODERN VARIABLES --- */
:root { 
  --border-color: #e2e8f0; 
  --bg-color: #f8fafc; 
  --primary-blue: #2563eb; 
  --text-dark: #1e293b;
  --text-gray: #64748b;
  --danger: #ef4444;
}

* { box-sizing: border-box; outline: none; }
body { margin: 0; background: var(--bg-color); font-family: 'Inter', "Segoe UI", Roboto, sans-serif; font-size: 13px; color: var(--text-dark); }

/* --- NAVIGATION --- */
.top-bar { padding: 12px 32px; background: #fff; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
.brand { font-weight: 700; font-size: 16px; color: var(--text-dark); display: flex; align-items: center; gap: 6px; }
.nav-menu { display: flex; gap: 4px; }
.nav-item { text-decoration: none; color: var(--text-gray); padding: 8px 14px; border-radius: 6px; font-weight: 500; transition: all 0.2s; }
.nav-item:hover { background: #eff6ff; color: var(--primary-blue); }
.nav-item.active { background: #eff6ff; color: var(--primary-blue); font-weight: 600; }

/* --- CONTAINER --- */
.page { max-width: 1200px; margin: 32px auto; padding: 0 20px; }
.card { background: #fff; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); padding: 32px; border: 1px solid var(--border-color); }
.card-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; color: var(--text-dark); display: flex; align-items: center; justify-content: space-between; }

/* --- FORMS --- */
label { font-size: 12px; font-weight: 600; color: var(--text-gray); display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.input-box { width: 100%; height: 38px; padding: 0 12px; font-size: 13px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; transition: border 0.2s; color: var(--text-dark); }
.input-box:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
.input-box[readonly] { background: #f1f5f9; color: var(--text-gray); cursor: default; }

.row-flex { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }

/* --- TABLE --- */
table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 16px; }
th { background: #f8fafc; padding: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-gray); border-bottom: 1px solid var(--border-color); text-align: left; }
td { padding: 8px; border-bottom: 1px solid var(--border-color); background: #fff; vertical-align: top; }
tr:last-child td { border-bottom: none; }

.hidden-col { display: none; }
.table-input { width: 100%; border: 1px solid var(--border-color); border-radius: 4px; padding: 6px; font-size: 13px; }

/* --- CHOICES.JS CUSTOMIZATION (MODERN LOOK) --- */
.choices { margin-bottom: 0; }
.choices__inner { min-height: 38px !important; border: 1px solid var(--border-color) !important; background: #fff !important; border-radius: 6px !important; padding: 4px 8px !important; display: flex; align-items: center; }
.choices__input { background: transparent !important; margin-bottom: 0 !important; }
.choices__list--dropdown { border: 1px solid var(--border-color) !important; border-radius: 8px !important; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important; margin-top: 4px !important; padding: 4px !important; }
.choices__list--dropdown .choices__item { border-radius: 4px; font-size: 13px; padding: 8px 12px; }
.choices__list--dropdown .choices__item--selectable.is-highlighted { background-color: #eff6ff !important; color: var(--primary-blue); }

/* Custom Badge untuk Sisa Coil */
.kpc-balance { 
  float: right; 
  font-size: 11px; 
  background: #f1f5f9; 
  color: #64748b; 
  padding: 2px 8px; 
  border-radius: 12px; 
  font-weight: 500;
}

/* --- BUTTONS --- */
.action-btn { border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
.add-row-btn { background: #eff6ff; color: var(--primary-blue); padding: 8px 16px; }
.add-row-btn:hover { background: #dbeafe; }

.submit-btn { background: var(--primary-blue); color: #fff; padding: 10px 32px; float: right; margin-top: 16px; box-shadow: 0 4px 6px -1px rgba(37,99,235,0.2); }
.submit-btn:hover { background: #1d4ed8; transform: translateY(-1px); }

.delete-btn { color: var(--text-gray); cursor: pointer; text-align: center; padding: 8px; border-radius: 4px; transition: 0.2s; }
.delete-btn:hover { color: var(--danger); background: #fef2f2; }

.row-handle { cursor: grab; color: #cbd5e1; text-align: center; padding-top: 12px; font-size: 18px; }
.row-handle:hover { color: var(--text-gray); }

/* --- LOADING --- */
#loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; z-index: 9999; }
.spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* --- NOTES TEXTAREA --- */
textarea { width: 100%; border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; font-family: inherit; font-size: 13px; resize: vertical; min-height: 80px; }
textarea:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

</style>
</head>

<body>
<div id="loadingOverlay"><div class="spinner"></div></div>

<div class="top-bar">
  <div class="brand">AUXILIUM <span style="font-weight:400; color:#94a3b8; font-size:14px; margin-left:4px;">Accounting</span></div>
  <nav class="nav-menu">
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/index.html" class="nav-item">Home</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/" class="nav-item">Receiving</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/" class="nav-item active">Production</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/reviewinvoice/" class="nav-item">Review Invoice</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/orderform/" class="nav-item">Sales Order</a>
  </nav>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">
      Production Entry
      <span style="font-size:12px; font-weight:500; color:#64748b; background:#f1f5f9; padding:4px 10px; border-radius:20px;" id="status-badge">New Entry</span>
    </div>

    <div class="row-flex">
      <div>
        <label>Date</label>
        <input type="date" id="productionDate" class="input-box">
      </div>
      <div>
        <label>Production Entry ID</label>
        <input type="text" id="entryId" class="input-box" readonly placeholder="Auto Generated...">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:30px;"></th>
          <th style="width:22%;">Machine</th> 
          <th style="width:28%;">Item</th>
          <th class="hidden-col">Meter</th>
          <th class="hidden-col">Qty</th>
          <th class="hidden-col">Total</th>
          <th>KPC (Rincian Sisa Coil)</th>
          <th style="width:30px;"></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <button class="action-btn add-row-btn" onclick="addRow()">+ Add Row</button>
    
    <div style="margin-top: 24px;">
      <label>Additional Notes</label>
      <textarea id="notes" placeholder="Enter any specific notes regarding this production batch..."></textarea>
    </div>
    
    <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:20px;">
      <button class="action-btn submit-btn" onclick="submitForm()">Submit Entry</button>
      <div style="clear:both;"></div>
    </div>
  </div>
</div>

<script>
// !!! GANTI URL INI DENGAN DEPLOYMENT ID TERBARU ANDA !!!
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMAhADzLxtfMTSrC7KnUSieVTy5DYF5kiAlnrHF6zb3GTwo4D8ZiUto4uA8PAw12qpmg/exec";

let allItemsData = []; 
let allKPCData = [];    
let uniqueMachines = [];

/* --- INITIAL LOAD --- */
window.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("loadingOverlay").style.display = "flex";
  
  // Set Date Today
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("productionDate").value = `${yyyy}-${mm}-${dd}`;

  await loadNextEntryId();  

  try {
    const [itemRes, kpcRes] = await Promise.all([
      fetch(`${SCRIPT_URL}?action=getitem`),
      fetch(`${SCRIPT_URL}?action=getkpc`)
    ]);

    allItemsData = await itemRes.json();
    allKPCData = await kpcRes.json(); 

    const machinesSet = new Set(allItemsData.map(i => i.machine).filter(m => m));
    uniqueMachines = Array.from(machinesSet).sort();

    addRow(); 
    setupSortable();
  } catch (e) {
    alert("Error loading data from server.");
    console.error(e);
  }
  document.getElementById("loadingOverlay").style.display = "none";
});

/* --- ROW MANAGEMENT --- */
function addRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td class="row-handle">⋮⋮</td>
    <td><select class="machine-select"></select></td>
    <td><select class="item-select"></select></td>
    <td class="hidden-col"><input class="table-input meter" type="number" value="0"></td>
    <td class="hidden-col"><input class="table-input qty" type="number" value="0"></td>
    <td class="hidden-col"><input class="table-input total" type="number" value="0"></td>
    <td><select class="kpc-select"></select></td>
    <td class="delete-cell">
       <div class="delete-btn" onclick="removeRow(this)">✕</div>
    </td>
  `;
  document.getElementById("tableBody").appendChild(row);

  const machineSelect = row.querySelector(".machine-select");
  const itemSelect = row.querySelector(".item-select");
  const kpcSelect = row.querySelector(".kpc-select");

  // Init Machine
  initChoices(machineSelect, uniqueMachines.map(m => ({value: m, label: m})), "Select Machine");
  
  // Init Item & KPC (Empty)
  initChoices(itemSelect, [], "Select Machine First");
  initChoices(kpcSelect, [], "Select Item First", true); // Pass true for custom template

  // EVENT: Machine Change
  machineSelect.addEventListener("change", function(e) {
    updateDropdown(itemSelect, [], "Select Machine First");
    updateDropdown(kpcSelect, [], "Select Item First", true);

    if (e.target.value) {
      const filtered = allItemsData
        .filter(i => i.machine === e.target.value)
        .map(i => ({ value: i.name, label: i.name }));
      updateDropdown(itemSelect, filtered, "Select Item");
    }
  });

  // EVENT: Item Change
  itemSelect.addEventListener("change", function(e) {
    const selectedItem = e.target.value;
    let kpcOptions = [];
    let placeholder = "Select Item First";

    if (selectedItem) {
      placeholder = "Select KPC";
      
      kpcOptions = allKPCData
        .filter(k => k.relatedItem === selectedItem)
        .map(k => {
          const formattedSisa = new Intl.NumberFormat('id-ID').format(k.sisa || 0);
          return {
            value: k.name,            // VALUE YANG DISIMPAN: HANYA NAMA
            label: k.name,            // LABEL SAAT DIPILIH: HANYA NAMA
            customProperties: {       // DATA TAMBAHAN UNTUK DISPLAY
               sisa: formattedSisa 
            }
          };
        });
    }
    // Update Dropdown dengan Custom Template flag = true
    updateDropdown(kpcSelect, kpcOptions, placeholder, true);
  });
}

function removeRow(btn) {
  const row = btn.closest('tr');
  // Pastikan setidaknya ada 1 baris tersisa jika diinginkan, atau biarkan kosong
  if(document.querySelectorAll('#tableBody tr').length > 1) {
    row.remove();
  } else {
    // Reset baris terakhir jika user menghapus satu-satunya baris (opsional)
    // alert("Cannot delete the last row");
    row.remove(); // Atau biarkan kosong
  }
}

/* --- CHOICES HELPER --- */
function updateDropdown(el, options, placeholder, useTemplate = false) {
  if (el.choicesInstance) {
    el.choicesInstance.destroy();
    el.choicesInstance = null;
  }
  el.innerHTML = ""; 
  initChoices(el, options, placeholder, useTemplate);
}

function initChoices(el, options, placeholder, useTemplate = false) {
  // Tambahkan placeholder option kosong
  /* Choices.js handles placeholder via config, but explicit empty option is safer for logic */
  
  const config = {
    searchEnabled: true,
    itemSelectText: "",
    shouldSort: false,
    placeholder: true,
    placeholderValue: placeholder,
    allowHTML: true, // PENTING: Izinkan HTML di dalam template
  };

  // !!! MAGIC SAUCE: CUSTOM TEMPLATE UNTUK DROPDOWN LIST !!!
  if (useTemplate) {
    config.callbackOnCreateTemplates = function(template) {
      return {
        item: ({ classNames }, data) => {
          // Tampilan saat SUDAH DIPILIH (Hanya Nama)
          return template(`
            <div class="${classNames.item} ${classNames.itemChoice} ${classNames.itemSelectable}" data-item data-id="${data.id}" data-value="${data.value}" ${data.active ? 'aria-selected="true"' : ''} ${data.disabled ? 'aria-disabled="true"' : ''}>
              ${data.label}
            </div>
          `);
        },
        choice: ({ classNames }, data) => {
          // Tampilan di dalam LIST DROPDOWN (Nama + Sisa)
          const sisa = data.customProperties && data.customProperties.sisa 
                       ? `<span class="kpc-balance">Sisa: ${data.customProperties.sisa}</span>` 
                       : '';
          
          return template(`
            <div class="${classNames.item} ${classNames.itemChoice} ${data.disabled ? classNames.itemDisabled : classNames.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${data.disabled ? 'data-choice-disabled aria-disabled="true"' : 'data-choice-selectable'} data-id="${data.id}" data-value="${data.value}" ${data.groupId > 0 ? 'role="treeitem"' : 'role="option"'}>
              <span style="font-weight:600;">${data.label}</span> ${sisa}
            </div>
          `);
        },
      };
    };
  }

  const choices = new Choices(el, config);
  
  // Set options secara dinamis
  if(options.length > 0) {
      choices.setChoices(options, 'value', 'label', true);
  }

  el.choicesInstance = choices;
}

/* --- SERVER LOGIC --- */
async function loadNextEntryId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastid`);
    const data = await res.json();
    const today = new Date();
    // Format FGP + YYMM
    const prefix = `FGP${String(today.getFullYear()).slice(2)}${String(today.getMonth()+1).padStart(2,"0")}`;
    const lastId = data.lastId;
    
    let nextId = prefix + "0000001";
    if (lastId && lastId.startsWith(prefix)) {
      const num = parseInt(lastId.substring(7), 10);
      nextId = prefix + String(num + 1).padStart(7, "0");
    }
    document.getElementById("entryId").value = nextId;
  } catch(e) {
    console.error("Failed to load ID", e);
  }
}

function submitForm() {
  const dateVal = document.getElementById("productionDate").value;
  if (!dateVal) return alert("Please select a Production Date");
  
  const rows = document.querySelectorAll("#tableBody tr");
  if (!rows.length) return alert("Please add at least one item row");

  const items = [];
  let isValid = true;

  rows.forEach(r => {
    // Ambil value dari property Choices JS instance jika ada, atau fallback ke value element
    const mSelect = r.querySelector(".machine-select");
    const iSelect = r.querySelector(".item-select");
    const kSelect = r.querySelector(".kpc-select");
    
    const m = mSelect.choicesInstance ? mSelect.choicesInstance.getValue(true) : mSelect.value;
    const i = iSelect.choicesInstance ? iSelect.choicesInstance.getValue(true) : iSelect.value;
    const k = kSelect.choicesInstance ? kSelect.choicesInstance.getValue(true) : kSelect.value;

    const meter = r.querySelector(".meter").value;
    const qty = r.querySelector(".qty").value;
    const total = r.querySelector(".total").value;

    if(!m || !i || !k) {
        isValid = false;
        // Highlight error visually (optional)
        if(!m) mSelect.closest('.choices').style.border = "1px solid red";
    }

    items.push({ 
        machine: m, 
        item: i, 
        kpc: k, // Ini sekarang sudah MURNI nama KPC karena logic templates kita
        meter: meter, 
        qty: qty, 
        total: total 
    });
  });

  if (!isValid) return alert("Please fill in all required fields (Machine, Item, and KPC).");

  if(!confirm("Are you sure you want to submit this entry?")) return;

  document.getElementById("loadingOverlay").style.display = "flex";

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      productionEntryId: document.getElementById("entryId").value,
      productionDate: dateVal,
      notes: document.getElementById("notes").value,
      items: items
    })
  })
  .then(res => res.json())
  .then(r => {
    document.getElementById("loadingOverlay").style.display = "none";
    if(r.status === "success") { 
        alert("Data Submitted Successfully!"); 
        window.location.reload(); 
    } else { 
        alert("Error: " + r.message); 
    }
  })
  .catch(err => {
      document.getElementById("loadingOverlay").style.display = "none";
      alert("Submission Failed: " + err);
  });
}

function setupSortable() {
  const tbody = document.getElementById("tableBody");
  Sortable.create(tbody, { 
      handle: ".row-handle", 
      animation: 150,
      ghostClass: 'bg-blue-50' // Class visual saat drag
  });
}
</script>
</body>
</html>
