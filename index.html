<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Production Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
/* CSS STYLE */
:root { --border: #d6dce1; --border-light: #e3e7eb; --bg: #f5f7fa; --blue: #0075c9; }
* { box-sizing: border-box; }
body { margin: 0; background: var(--bg); font-family: "Segoe UI", Roboto, sans-serif; font-size: 13px; color: #333; }

.top-bar { padding: 10px 36px; background: #fff; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 1000; font-weight: 600; font-size: 15px; }
.nav-menu { display: flex; gap: 8px; }
.nav-item { text-decoration: none; color: #64748b; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; }
.nav-item:hover { background: #f1f5f9; color: var(--blue); }
.nav-item.active { background: #eff6ff; color: var(--blue); font-weight: 600; }

.page { max-width: 1120px; margin: 32px auto; padding: 0 16px; }
.card { background: #fff; border-radius: 8px; box-shadow: 0 0 0 1px rgba(15,23,42,0.04), 0 14px 30px rgba(15,23,42,0.08); padding: 24px; }
.card-title { font-size: 20px; font-weight: 600; margin-bottom: 18px; color: #1f2933; }

label { font-size: 12.5px; font-weight: 600; color: #4a5568; display: block; margin-bottom: 4px; }
.input-box, .choices__inner { height: 32px !important; min-height: 32px !important; padding: 4px 8px !important; font-size: 12.5px !important; border: 1px solid #d0d7df !important; border-radius: 5px !important; background: #f9fafb !important; }

.row-flex { display: grid; grid-template-columns: 1fr 1fr; column-gap: 24px; margin-bottom: 18px; }

table { width: 100%; border-collapse: collapse; border: 1px solid #e3e6ea; border-radius: 6px; background: #fff; }
th { background: #edf0f5; padding: 8px; font-size: 12.5px; font-weight: 600; border-bottom: 1px solid #e1e4e9; text-align: left; }
td { padding: 4px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }

.choices__list--dropdown { z-index: 999999 !important; }
.hidden-col { display: none !important; }
.delete-btn { color: #cc1f2f; cursor: pointer; text-align: center; font-size: 14px; }
.row-handle { color: #999; cursor: grab; text-align: center; }

.add-row-btn { margin-top: 10px; padding: 6px 14px; background: #eef4ff; color: #1f5ddb; border: 1px solid #cfe0ff; border-radius: 5px; font-weight: 600; cursor: pointer; }
.submit-btn { padding: 9px 24px; background: #0f80d9; color: #fff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; float: right; margin-top: 22px; }

#loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.75); display: none; justify-content: center; align-items: center; z-index: 9999; }
.loading-spinner { border: 5px solid #dae6f4; border-top: 5px solid #2b6be8; border-radius: 50%; width: 42px; height: 42px; animation: spin .85s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>

<body>
<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div class="top-bar">
  <div style="display:flex;align-items:center;gap:8px;color:#1e1e1e;">AUXILIUM <span style="font-weight:300;color:#909090;">Accounting Management</span></div>
  <nav class="nav-menu">
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/index.html" class="nav-item">Home</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/" class="nav-item">Receiving</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/" class="nav-item active">Production</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/reviewinvoice/" class="nav-item">Review Invoice</a>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/orderform/" class="nav-item">Sales Order</a>
  </nav>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">Production Entry</div>

    <div class="row-flex">
      <div><label>Date</label><input type="date" id="productionDate" class="input-box"></div>
      <div><label>Production Entry ID</label><input type="text" id="entryId" class="input-box" readonly></div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:20px;"></th>
          <th style="width:25%;">Machine</th> 
          <th style="width:30%;">Item</th>
          <th class="hidden-col">Meter</th>
          <th class="hidden-col">Qty</th>
          <th class="hidden-col">Total</th>
          <th>KPC (Rincian Sisa Coil)</th>
          <th style="width:20px;"></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <button class="add-row-btn" onclick="addRow()">+ Add row</button>
    
    <div style="margin-top: 20px; font-weight:600; color:#4a5568;">Additional Notes</div>
    <textarea id="notes" style="width:100%; height:80px; margin-top:4px; border:1px solid #d0d7df; border-radius:5px;"></textarea>
    
    <button class="submit-btn" onclick="submitForm()">Submit</button>
    <div style="clear:both;"></div>
  </div>
</div>

<script>
// !!! GANTI URL INI DENGAN DEPLOYMENT ID TERBARU ANDA !!!
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzn1OIVcu6RUljERn1SeN0iDg0Tabw4AZ8pETN-1f7T1h3ZEkaBUwRq09OvGyn3mGxRdg/exec";

let allItemsData = []; 
let allKPCData = [];   
let uniqueMachines = [];

/* LOAD DATA */
window.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("loadingOverlay").style.display = "flex";
  
  // --- SET DEFAULT DATE TO TODAY ---
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("productionDate").value = `${yyyy}-${mm}-${dd}`;
  // ---------------------------------

  await loadNextEntryId();  

  try {
    const [itemRes, kpcRes] = await Promise.all([
      fetch(`${SCRIPT_URL}?action=getitem`),
      fetch(`${SCRIPT_URL}?action=getkpc`)
    ]);

    allItemsData = await itemRes.json();
    allKPCData = await kpcRes.json(); 

    const machinesSet = new Set(allItemsData.map(i => i.machine).filter(m => m));
    uniqueMachines = Array.from(machinesSet).sort();

    addRow(); 
    setupSortable();
  } catch (e) {
    alert("Error loading data.");
    console.error(e);
  }
  document.getElementById("loadingOverlay").style.display = "none";
});

/* ADD ROW */
function addRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td class="row-handle">â‹®â‹®</td>
    <td><select class="machine-select"></select></td>
    <td><select class="item-select"></select></td>
    <td class="hidden-col"><input class="table-input meter" value="0"></td>
    <td class="hidden-col"><input class="table-input qty" value="0"></td>
    <td class="hidden-col"><input class="table-input total" value="0"></td>
    <td><select class="kpc-select"></select></td>
    <td class="delete-btn" onclick="this.closest('tr').remove()">ðŸ—‘</td>
  `;
  document.getElementById("tableBody").appendChild(row);

  const machineSelect = row.querySelector(".machine-select");
  const itemSelect = row.querySelector(".item-select");
  const kpcSelect = row.querySelector(".kpc-select");

  // Init Machine
  initChoices(machineSelect, uniqueMachines.map(m => ({value: m, label: m})), "Select Machine");
  
  // Init Item & KPC (Empty)
  initChoices(itemSelect, [], "Select Machine First");
  initChoices(kpcSelect, [], "Select Item First");

  // EVENT: Machine Change
  machineSelect.addEventListener("change", function(e) {
    updateDropdown(itemSelect, [], "Select Machine First");
    updateDropdown(kpcSelect, [], "Select Item First");

    if (e.target.value) {
      const filtered = allItemsData
        .filter(i => i.machine === e.target.value)
        .map(i => ({ value: i.name, label: i.name }));
      updateDropdown(itemSelect, filtered, "Select Item");
    }
  });

  // EVENT: Item Change (FILTER KPC & FORMAT LABEL)
  itemSelect.addEventListener("change", function(e) {
    const selectedItem = e.target.value;
    let kpcOptions = [];
    let placeholder = "Select Item First";

    if (selectedItem) {
      placeholder = "Select KPC";
      
      kpcOptions = allKPCData
        .filter(k => k.relatedItem === selectedItem)
        .map(k => {
          // FORMAT ANKA SISA COIL
          const formattedSisa = new Intl.NumberFormat('id-ID').format(k.sisa || 0);
          return {
            value: k.name,
            // LABEL: "AKJ001 (Sisa: 5.500)"
            label: `${k.name} (Sisa: ${formattedSisa})`
          };
        });
    }
    updateDropdown(kpcSelect, kpcOptions, placeholder);
  });
}

/* HELPER: Update Choices */
function updateDropdown(el, options, placeholder) {
  if (el.choicesInstance) el.choicesInstance.destroy();
  el.innerHTML = "";
  initChoices(el, options, placeholder);
}

/* HELPER: Init Choices (Generic) */
function initChoices(el, options, placeholder) {
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = placeholder;
  el.appendChild(ph);

  options.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    el.appendChild(o);
  });

  el.choicesInstance = new Choices(el, {
    searchEnabled: true,
    itemSelectText: "",
    shouldSort: false,
    placeholderValue: placeholder
  });
}

/* ID & SUBMIT Logic */
async function loadNextEntryId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastid`);
    const data = await res.json();
    const today = new Date();
    const prefix = `FGP${String(today.getFullYear()).slice(2)}${String(today.getMonth()+1).padStart(2,"0")}`;
    const lastId = data.lastId;
    
    if (!lastId || !lastId.startsWith(prefix)) {
      document.getElementById("entryId").value = prefix + "0000001";
    } else {
      document.getElementById("entryId").value = prefix + String(parseInt(lastId.substring(7))+1).padStart(7,"0");
    }
  } catch(e) {}
}

function submitForm() {
  const dateVal = document.getElementById("productionDate").value;
  if (!dateVal) return alert("Select Date");
  
  const rows = document.querySelectorAll("#tableBody tr");
  if (!rows.length) return alert("Add at least 1 row");

  const items = [];
  let valid = true;

  rows.forEach(r => {
    const m = r.querySelector(".machine-select").value;
    const i = r.querySelector(".item-select").value;
    const k = r.querySelector(".kpc-select").value;
    if(!m || !i || !k) valid = false;
    items.push({ machine: m, item: i, kpc: k, meter:0, qty:0, total:0 });
  });

  if (!valid) return alert("Fill all fields (Machine, Item, KPC)");

  document.getElementById("loadingOverlay").style.display = "flex";
  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      productionEntryId: document.getElementById("entryId").value,
      productionDate: dateVal,
      notes: document.getElementById("notes").value,
      items: items
    })
  })
  .then(res => res.json())
  .then(r => {
    document.getElementById("loadingOverlay").style.display = "none";
    if(r.status === "success") { alert("Success!"); window.location.reload(); }
    else alert("Error: " + r.message);
  });
}

function setupSortable() {
  Sortable.create(document.getElementById("tableBody"), { handle: ".row-handle", animation: 150 });
}
</script>
</body>
</html>
