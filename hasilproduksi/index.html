<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Production Management</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
  .active-tab { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
  .inactive-tab { color: #64748b; border-bottom: 2px solid transparent; }
  .inactive-tab:hover { color: #334155; border-bottom: 2px solid #e2e8f0; }
   
  /* Style untuk Sub-Menu Pills */
  .sub-pill { padding: 4px 12px; border-radius: 9999px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
  .sub-pill-active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
  .sub-pill-inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
  .sub-pill-inactive:hover { background-color: #f1f5f9; color: #334155; }

  #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 50; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
  .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6; border-radius: 50%; width: 45px; height: 45px; animation: spin 0.8s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .input-xs { padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; width: 100%; transition: border 0.2s; }
  .input-xs:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
  .input-readonly { background-color: #f8fafc; color: #64748b; cursor: not-allowed; border-color: #e2e8f0; }
  select.input-xs { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; appearance: none; }
</style>
</head>

<body class="text-slate-800">

<div id="loading"><div class="spinner"></div></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
   
  <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Production Management</h1>
      <p class="text-sm text-slate-500 mt-1">Manage production queue, results, and Xero sync.</p>
    </div>
    <button onclick="fetchData()" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2.5 rounded-lg text-sm font-medium transition shadow-sm flex items-center justify-center">
      <i class="fas fa-sync-alt mr-2"></i> Refresh Data
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
      <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
      <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Queue</div>
      <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="count-queue">0</span></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
      <div class="absolute right-0 top-0 h-full w-1 bg-emerald-500"></div>
      <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Completed</div>
      <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="count-completed">0</span></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
      <div class="absolute right-0 top-0 h-full w-1 bg-indigo-500"></div>
      <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">To Sync</div>
      <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="count-import">0</span></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
      <div class="absolute right-0 top-0 h-full w-1 bg-gray-500"></div>
      <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Monitoring</div>
      <div class="flex items-baseline"><span class="text-3xl font-bold text-slate-800" id="count-monitoring">0</span></div>
    </div>
  </div>

  <div class="border-b border-slate-200 mb-6">
    <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
      <button onclick="switchTab('queue')" id="tab-queue" class="active-tab whitespace-nowrap py-4 px-1 font-medium text-sm transition-colors">Siap Untuk Di Produksi</button>
      <button onclick="switchTab('completed')" id="tab-completed" class="inactive-tab whitespace-nowrap py-4 px-1 font-medium text-sm transition-colors">Sudah Di Produksi</button>
      <button onclick="switchTab('import')" id="tab-import" class="inactive-tab whitespace-nowrap py-4 px-1 font-medium text-sm transition-colors">Siap Import Xero</button>
      <button onclick="switchTab('monitoring')" id="tab-monitoring" class="inactive-tab whitespace-nowrap py-4 px-1 font-medium text-sm transition-colors">Monitoring Xero</button>
    </nav>
  </div>

  <div id="monitoring-submenu" class="hidden mb-6 flex gap-3 overflow-x-auto pb-2">
    <button onclick="switchSubTab('all')" id="sub-all" class="sub-pill sub-pill-active">All Status</button>
    <button onclick="switchSubTab('Proses')" id="sub-proses" class="sub-pill sub-pill-inactive">
      <i class="fas fa-spinner fa-spin mr-1.5 text-xs"></i>Proses
    </button>
    <button onclick="switchSubTab('Sukses')" id="sub-sukses" class="sub-pill sub-pill-inactive">
      <i class="fas fa-check-circle mr-1.5 text-xs text-emerald-500"></i>Sukses
    </button>
    <button onclick="switchSubTab('Gagal')" id="sub-gagal" class="sub-pill sub-pill-inactive">
      <i class="fas fa-times-circle mr-1.5 text-xs text-red-500"></i>Gagal
    </button>
  </div>

  <div class="mb-6">
    <div class="relative max-w-md">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fas fa-search text-slate-400"></i>
      </div>
      <input type="text" id="searchInput" onkeyup="renderData()" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm shadow-sm" placeholder="Search ID, Machine, or Item...">
    </div>
  </div>

  <div id="list-container" class="space-y-4 pb-20"></div>

</div>

<div id="modalResult" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity backdrop-blur-sm" aria-hidden="true"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-7xl sm:w-full">
       
      <div class="bg-white px-6 py-5 border-b border-slate-100 flex justify-between items-start">
        <div>
          <h3 class="text-xl font-bold text-slate-900" id="modal-title">Input Production Result</h3>
          <div class="mt-1 text-sm text-slate-500">Entry ID: <span id="modal-batch-id" class="font-mono font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded"></span></div>
        </div>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="bg-slate-50 px-6 py-6">
        <div class="overflow-visible rounded-lg border border-slate-200 shadow-sm">
          <table class="min-w-full divide-y divide-slate-200 bg-white">
            <thead class="bg-slate-50">
              <tr id="modal-table-header"></tr>
            </thead>
            <tbody id="modal-table-body" class="divide-y divide-slate-200"></tbody>
          </table>
          <div id="add-row-container" class="hidden bg-slate-50 px-4 py-3 border-t border-slate-200">
             <button onclick="addNewRow()" class="text-sm text-blue-600 font-semibold hover:text-blue-800 flex items-center"><i class="fas fa-plus-circle mr-2"></i> Add Row</button>
          </div>
        </div>
        <div class="mt-4 flex items-start p-3 bg-amber-50 border border-amber-200 rounded-lg" id="modal-warning">
          <i class="fas fa-exclamation-circle text-amber-500 mt-0.5 mr-2"></i>
          <p class="text-xs text-amber-700" id="modal-warning-text"></p>
        </div>
      </div>

      <div class="bg-white px-6 py-4 flex flex-row-reverse gap-3 border-t border-slate-100" id="modal-footer"></div>
    </div>
  </div>
</div>

<script>
// =================================================================
// GANTI URL API ANDA DI SINI
const API_URL = "https://script.google.com/macros/s/AKfycbwTDlBQQvDdLFpyXNq_b4YhXaE9YsFBgt5WY1fdK3mMuDyoQ3NqcZ8jRhZfdHN8Wf3l/exec"; 
// =================================================================

let RAW_DATA = [];
let GROUPED_DATA = {};
let OPTIONS = { items: [], kpcs: [] };
let CURRENT_TAB = 'queue';
let CURRENT_SUB_TAB = 'all'; 
let CURRENT_BATCH_ID = null;
let CURRENT_BATCH_DATE = null;
let CURRENT_MODE = ''; 

// STATUS BARU
const MONITORING_STATUSES = ['Proses', 'Sukses', 'Gagal'];

window.addEventListener('DOMContentLoaded', () => { fetchData(); });

async function fetchData() {
  document.getElementById('loading').style.display = 'flex';
  try {
    const [dataRes, optionsRes] = await Promise.all([
      fetch(`${API_URL}?action=getData`),
      fetch(`${API_URL}?action=getOptions`)
    ]);
    RAW_DATA = await dataRes.json();
    OPTIONS = await optionsRes.json();
    processData();
    updateCounts();
    renderData();
  } catch (err) { 
    Swal.fire('Error', err.toString(), 'error');
  } 
  finally { document.getElementById('loading').style.display = 'none'; }
}

function processData() {
  GROUPED_DATA = {};
  RAW_DATA.forEach(row => {
    const allowed = ['Siap Untuk Di Produksi', 'Sudah Di Produksi', 'Siap Import', ...MONITORING_STATUSES];
    
    if(!allowed.includes(row.status)) return;
    
    if (!GROUPED_DATA[row.id]) {
      GROUPED_DATA[row.id] = { id: row.id, date: row.date, status: row.status, timestamp: row.timestamp, items: [] };
    }
    GROUPED_DATA[row.id].items.push(row);
  });
}

function updateCounts() {
  let q = 0, c = 0, i = 0, m = 0;
  Object.values(GROUPED_DATA).forEach(batch => {
    const st = batch.items[0].status;
    if (st === 'Siap Untuk Di Produksi') q++;
    else if (st === 'Sudah Di Produksi') c++;
    else if (st === 'Siap Import') i++;
    else if (MONITORING_STATUSES.includes(st)) m++;
  });
  document.getElementById('count-queue').innerText = q;
  document.getElementById('count-completed').innerText = c;
  document.getElementById('count-import').innerText = i;
  document.getElementById('count-monitoring').innerText = m;
}

function switchTab(tabName) {
  CURRENT_TAB = tabName;
   
  ['queue', 'completed', 'import', 'monitoring'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    t === tabName ? (el.classList.remove('inactive-tab'), el.classList.add('active-tab')) : (el.classList.remove('active-tab'), el.classList.add('inactive-tab'));
  });

  const subMenu = document.getElementById('monitoring-submenu');
  if (tabName === 'monitoring') {
    subMenu.classList.remove('hidden');
    switchSubTab('all');
  } else {
    subMenu.classList.add('hidden');
  }

  renderData();
}

function switchSubTab(subName) {
  CURRENT_SUB_TAB = subName;
   
  const pills = ['all', 'proses', 'sukses', 'gagal'];
  pills.forEach(p => {
    let id = 'sub-' + p; 
    let el = document.getElementById(id);
    
    let isMatch = false;
    if (subName === 'all' && p === 'all') isMatch = true;
    if (subName === 'Proses' && p === 'proses') isMatch = true;
    if (subName === 'Sukses' && p === 'sukses') isMatch = true;
    if (subName === 'Gagal' && p === 'gagal') isMatch = true;

    if (isMatch) {
      el.classList.remove('sub-pill-inactive');
      el.classList.add('sub-pill-active');
    } else {
      el.classList.remove('sub-pill-active');
      el.classList.add('sub-pill-inactive');
    }
  });

  renderData();
}

function renderData() {
  const container = document.getElementById('list-container');
  container.innerHTML = '';
  const search = document.getElementById('searchInput').value.toLowerCase();
   
  const batches = Object.values(GROUPED_DATA).filter(batch => {
    const st = batch.items[0].status;
    let matchTab = false;

    if (CURRENT_TAB === 'queue' && st === 'Siap Untuk Di Produksi') matchTab = true;
    else if (CURRENT_TAB === 'completed' && st === 'Sudah Di Produksi') matchTab = true;
    else if (CURRENT_TAB === 'import' && st === 'Siap Import') matchTab = true;
    else if (CURRENT_TAB === 'monitoring') {
      if (MONITORING_STATUSES.includes(st)) {
        if (CURRENT_SUB_TAB === 'all') matchTab = true;
        else if (CURRENT_SUB_TAB === st) matchTab = true;
      }
    }
    
    if (!matchTab) return false;
    const searchString = (batch.id + batch.items.map(i => i.item + i.machine).join(' ')).toLowerCase();
    return searchString.includes(search);
  });

  batches.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  if (batches.length === 0) {
    container.innerHTML = `<div class="text-center py-16 text-slate-400">Tidak ada data.</div>`;
    return;
  }

  batches.forEach(batch => {
    let actionBtn = '';
    const currentStatus = batch.items[0].status;
    
    if (CURRENT_TAB === 'queue') {
      actionBtn = `
        <div class="flex gap-2">
          <button onclick="openInputModal('${batch.id}', 'plan_edit')" class="bg-amber-100 hover:bg-amber-200 text-amber-700 border border-amber-200 px-3 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center"><i class="fas fa-edit mr-2"></i> Edit Plan</button>
          <button onclick="openInputModal('${batch.id}', 'result_input')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center"><i class="fas fa-clipboard-check mr-2"></i> Input Result</button>
        </div>`;
    } else if (CURRENT_TAB === 'completed') {
      actionBtn = `
        <div class="flex gap-2">
          <button onclick="openInputModal('${batch.id}', 'result_revise')" class="bg-amber-100 hover:bg-amber-200 text-amber-700 border border-amber-200 px-3 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center"><i class="fas fa-pen mr-2"></i> Revisi</button>
          <button onclick="approveBatch('${batch.id}')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center"><i class="fas fa-check-circle mr-2"></i> Approve</button>
        </div>`;
    } else if (CURRENT_TAB === 'import') {
       actionBtn = `<button onclick="syncXero('${batch.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center"><i class="fas fa-cloud-upload-alt mr-2"></i> Sync Xero</button>`;
    } else if (CURRENT_TAB === 'monitoring') {
       let badgeClass = "bg-gray-100 text-gray-600 border-gray-200";
       let icon = "";
       
       if(currentStatus === 'Proses') {
          badgeClass = "bg-sky-50 text-sky-600 border-sky-100";
          icon = "<i class='fas fa-spinner fa-spin mr-2'></i>";
       } else if (currentStatus === 'Sukses') {
          badgeClass = "bg-emerald-50 text-emerald-600 border-emerald-100";
          icon = "<i class='fas fa-check-circle mr-2'></i>";
       } else if (currentStatus === 'Gagal') {
          badgeClass = "bg-red-50 text-red-600 border-red-100";
          icon = "<i class='fas fa-times-circle mr-2'></i>";
       }
       
       actionBtn = `<div class="px-4 py-1.5 rounded-full text-xs font-bold border flex items-center ${badgeClass}">${icon} ${currentStatus.toUpperCase()}</div>`;
    }

    let itemRows = '';
    batch.items.forEach(item => {
      const resultDisplay = (CURRENT_TAB !== 'queue') ? `<div class="ml-auto text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded border border-slate-200 flex gap-3"><span>Qty: <b>${item.qty}</b></span><span>M: <b>${item.meter}</b></span><span>Kg: <b>${item.weight}</b></span></div>` : '<div class="ml-auto"></div>';
      
      // === LOGIKA BARU: CARI SISA KPC ===
      const matchedKpc = OPTIONS.kpcs.find(k => k.name === item.kpc);
      const sisaValue = matchedKpc ? new Intl.NumberFormat('id-ID').format(matchedKpc.sisa) : '-';
      
      itemRows += `
        <div class="flex items-center justify-between py-2 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition px-2 -mx-2 rounded">
           <div class="flex items-center flex-1 gap-4">
             <span class="w-2 h-2 rounded-full bg-blue-400"></span>
             <div class="w-32 text-xs font-semibold text-slate-500 bg-slate-100 px-2 py-1 rounded text-center">${item.machine}</div>
             <div class="text-sm font-medium text-slate-700 w-48">${item.item}</div>
             
             <div class="flex items-center gap-2">
                <div class="text-xs text-slate-600 font-mono font-bold">${item.kpc}</div>
                <div class="text-xs text-slate-500 bg-white border border-slate-200 px-2 py-0.5 rounded-md shadow-sm whitespace-nowrap" title="Sisa KPC">
                    <span class="text-[10px] uppercase text-slate-400 mr-1">Sisa:</span>
                    <span class="font-bold text-slate-700">${sisaValue}</span>
                </div>
             </div>
             
           </div>
           ${resultDisplay}
        </div>`;
    });

    container.innerHTML += `
      <div class="bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition duration-200 overflow-hidden">
        <div class="px-6 py-4 flex items-center justify-between bg-slate-50 border-b border-slate-100">
          <div>
            <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">ID</div>
            <div class="text-lg font-bold text-slate-800 font-mono">${batch.id}</div>
            <div class="text-xs text-slate-500 mt-1"><i class="far fa-calendar-alt mr-1.5"></i> ${batch.date}</div>
          </div>
          <div>${actionBtn}</div>
        </div>
        <div class="px-6 py-4">${itemRows}</div>
      </div>`;
  });
}

function openInputModal(batchId, mode) {
  CURRENT_BATCH_ID = batchId;
  CURRENT_MODE = mode; 
  const batch = GROUPED_DATA[batchId];
  CURRENT_BATCH_DATE = batch.date;
   
  document.getElementById('modal-batch-id').innerText = batchId;
   
  let title = "Form";
  let warning = "";
   
  if (CURRENT_MODE === 'plan_edit') {
      title = "Edit Production Plan";
      warning = "<strong>Mode Edit Plan:</strong> Ubah Mesin/Item/KPC atau tambah baris. Angka hasil produksi belum diinput.";
  } else if (CURRENT_MODE === 'result_input') {
      title = "Input Production Result";
      warning = "<strong>Mode Input Hasil:</strong> Masukkan angka aktual (Qty/Meter/Berat). Mesin & Item terkunci.";
  } else if (CURRENT_MODE === 'result_revise') {
      title = "Revisi Production Result";
      warning = "<strong>Mode Revisi:</strong> Perbaiki angka salah input. Data Mesin & Item tetap terkunci.";
  }

  document.getElementById('modal-title').innerText = title;
  document.getElementById('modal-warning-text').innerHTML = warning;
  document.getElementById('add-row-container').classList.toggle('hidden', CURRENT_MODE !== 'plan_edit');

  const thead = document.getElementById('modal-table-header');
  if (CURRENT_MODE === 'plan_edit') {
    thead.innerHTML = `
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-40">Machine</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-56">Item</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-56">KPC</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">WE Number</th>
      <th class="px-2 py-3 w-10">Action</th>`;
  } else {
    thead.innerHTML = `
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-40">Machine</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-48">Item</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-48">KPC</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-24">Meter</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-24">Qty</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-24">Berat (kg)</th>
      <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">WE Number</th>`;
  }

  const tbody = document.getElementById('modal-table-body');
  tbody.innerHTML = '';
  batch.items.forEach(item => { renderModalRow(item); });
  renderFooterButtons();
  document.getElementById('modalResult').classList.remove('hidden');
}

function renderModalRow(item = null) {
  const tbody = document.getElementById('modal-table-body');
  const rowIndex = item ? item.rowIndex : 'new';
  const itemVal = item ? item.item : '';
  const machineVal = item ? item.machine : '';
  const kpcVal = item ? item.kpc : '';
  const meterVal = item ? item.meter : 0;
  const qtyVal = item ? item.qty : 0;
  const weightVal = item ? item.weight : 0;
  const weVal = item ? item.weNumber : '';

  let html = '';

  if (CURRENT_MODE === 'plan_edit') {
    const machineOpts = [...new Set(OPTIONS.items.map(i => i.machine))].sort();
    let machineEl = `<select class="input-xs machine-select bg-white" onchange="onMachineChange(this)">
                        <option value="">Select Machine</option>
                        ${machineOpts.map(m => `<option value="${m}" ${m === machineVal ? 'selected' : ''}>${m}</option>`).join('')}
                      </select>`;
    let itemEl = `<select class="input-xs item-select bg-white" onchange="onItemChange(this)" data-current="${itemVal}"><option value="">Select Machine First</option></select>`;
    let kpcEl = `<select class="input-xs kpc-select bg-white" onchange="updateRowWE(this)" data-current="${kpcVal}"><option value="">Select Item First</option></select>`;
    let deleteBtn = `<button onclick="deleteRow(this)" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>`;

    html = `
      <td class="px-4 py-3">${machineEl}</td>
      <td class="px-4 py-3">${itemEl}</td>
      <td class="px-4 py-3">${kpcEl}</td>
      <td class="px-4 py-3"><input type="text" class="input-xs bg-slate-50 text-slate-500 we-preview font-mono text-xs cursor-not-allowed" value="${weVal}" readonly></td>
      <td class="px-2 py-3 text-center">${deleteBtn}</td>
    `;
  } else {
    html = `
      <td class="px-4 py-3"><input type="text" class="input-xs input-readonly machine-select" value="${machineVal}" readonly></td>
      <td class="px-4 py-3"><span class="text-sm font-medium text-slate-700">${itemVal}</span></td>
      <td class="px-4 py-3"><input type="text" class="input-xs input-readonly kpc-select" value="${kpcVal}" readonly></td>
      <td class="px-4 py-3"><input type="number" class="input-xs input-meter text-center font-mono" value="${meterVal}" min="0"></td>
      <td class="px-4 py-3"><input type="number" class="input-xs input-qty text-center font-mono" value="${qtyVal}" min="0"></td>
      <td class="px-4 py-3"><input type="number" class="input-xs input-weight text-center font-mono" value="${weightVal}" min="0"></td>
      <td class="px-4 py-3"><input type="text" class="input-xs bg-slate-50 text-slate-500 we-preview font-mono text-xs cursor-not-allowed" value="${weVal}" readonly></td>
    `;
  }

  const tr = document.createElement('tr');
  tr.setAttribute('data-row-index', rowIndex);
  tr.innerHTML = html;
  tbody.appendChild(tr);

  if (CURRENT_MODE === 'plan_edit' && machineVal) {
    setTimeout(() => { onMachineChange(tr.querySelector('.machine-select'), false); }, 0);
  }
}

function addNewRow() { renderModalRow(); }
function deleteRow(btn) { btn.closest('tr').remove(); }

function onMachineChange(el, resetValue = true) {
  if(!el) return;
  const tr = el.closest('tr');
  const selectedMachine = el.value;
  const itemSelect = tr.querySelector('.item-select');
  const currentItem = itemSelect.getAttribute('data-current');
  const validItems = OPTIONS.items.filter(i => i.machine === selectedMachine);
  itemSelect.innerHTML = `<option value="">Select Item</option>` + validItems.map(i => `<option value="${i.name}" ${!resetValue && i.name === currentItem ? 'selected' : ''}>${i.name}</option>`).join('');
  if(resetValue) { itemSelect.value = ""; onItemChange(itemSelect, true); } else { onItemChange(itemSelect, false); }
}

function onItemChange(el, resetValue = true) {
  if(!el) return;
  const tr = el.closest('tr');
  const selectedItem = el.value;
  const kpcSelect = tr.querySelector('.kpc-select');
  const currentKpc = kpcSelect.getAttribute('data-current');
  const validKPCs = OPTIONS.kpcs.filter(k => k.relatedItem === selectedItem);
  kpcSelect.innerHTML = `<option value="">Select KPC</option>` + validKPCs.map(k => {
        const label = `${k.name} (Sisa: ${new Intl.NumberFormat('id-ID').format(k.sisa)})`;
        return `<option value="${k.name}" ${!resetValue && k.name === currentKpc ? 'selected' : ''}>${label}</option>`;
    }).join('');
  if(resetValue) kpcSelect.value = "";
  updateRowWE(el);
}

function updateRowWE(el) {
  const tr = el.closest('tr');
  const machine = tr.querySelector('.machine-select').value;
  const kpc = tr.querySelector('.kpc-select').value;
  let item = (CURRENT_MODE === 'plan_edit') ? tr.querySelector('.item-select').value : tr.querySelector('span').innerText;
   
  if(!machine || !item || !kpc) return;

  let machineCode = "XX";
  const mUpper = machine.toUpperCase();
  if(mUpper.includes("RENG")) machineCode = "RG";
  else if(mUpper.includes("TRUSS")) machineCode = "TS";
  else machineCode = mUpper.substring(0,2);
   
  const machineDigits = machine.match(/\d+/);
  const machineNum = machineDigits ? machineDigits[0].slice(-2) : "00";
  const finalMachine = machineCode + machineNum;

  const itemDigitsMatch = item.match(/\d+/g); 
  let itemSuffix = "00";
  if(itemDigitsMatch) itemSuffix = itemDigitsMatch[itemDigitsMatch.length - 1].slice(-2);

  tr.querySelector('.we-preview').value = `${finalMachine}_${kpc}_${CURRENT_BATCH_ID}_${itemSuffix}`;
}

function renderFooterButtons() {
  const footer = document.getElementById('modal-footer');
  let btns = '';
   
  if (CURRENT_MODE === 'plan_edit') {
    btns = `<button onclick="submitForm('replaceBatch')" class="bg-amber-400 text-amber-900 px-5 py-2.5 rounded hover:bg-amber-500 font-semibold shadow-sm">Save Changes</button>`;
  } else if (CURRENT_MODE === 'result_input') {
    btns = `<button onclick="submitForm('replaceBatch', true)" class="bg-blue-600 text-white px-5 py-2.5 rounded hover:bg-blue-700 font-semibold shadow-sm">Submit & Complete</button>`;
  } else if (CURRENT_MODE === 'result_revise') {
    btns = `<button onclick="submitForm('replaceBatch', true)" class="bg-emerald-600 text-white px-5 py-2.5 rounded hover:bg-emerald-700 font-semibold shadow-sm">Simpan Revisi</button>`;
  }
   
  btns += `<button onclick="closeModal()" class="bg-white border px-5 py-2.5 rounded hover:bg-slate-50 font-medium text-slate-700 shadow-sm ml-2">Cancel</button>`;
  footer.innerHTML = btns;
}

function closeModal() { document.getElementById('modalResult').classList.add('hidden'); }

// === FUNGSI NOTIFIKASI MODERN (SweetAlert2) ===

async function submitForm(action, forceComplete = false) {
  const rows = document.querySelectorAll('#modal-table-body tr');
  const items = [];
  rows.forEach(tr => {
    let itemVal = "";
    if (CURRENT_MODE === 'plan_edit') {
        itemVal = tr.querySelector('.item-select').value;
    } else {
        itemVal = tr.querySelector('td:nth-child(2) span').innerText;
    }

    items.push({
      rowIndex: tr.getAttribute('data-row-index'),
      item: itemVal,
      machine: tr.querySelector('.machine-select').value,
      kpc: tr.querySelector('.kpc-select').value,
      meter: (CURRENT_MODE === 'plan_edit') ? 0 : tr.querySelector('.input-meter').value,
      qty: (CURRENT_MODE === 'plan_edit') ? 0 : tr.querySelector('.input-qty').value,
      weight: (CURRENT_MODE === 'plan_edit') ? 0 : tr.querySelector('.input-weight').value,
      weNumber: tr.querySelector('.we-preview').value,
      date: CURRENT_BATCH_DATE
    });
  });

  const result = await Swal.fire({
    title: 'Simpan Data?',
    text: "Pastikan data yang diinput sudah benar.",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#2563eb', 
    cancelButtonColor: '#64748b',  
    confirmButtonText: 'Ya, Simpan',
    cancelButtonText: 'Batal'
  });

  if (!result.isConfirmed) return;
   
  closeModal();
  await postAction(action, { batchId: CURRENT_BATCH_ID, items: items, forceComplete: forceComplete });
}

async function postAction(action, payload) {
  document.getElementById('loading').style.display = 'flex';
  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, ...payload }) });
    const result = await res.json();
    
    if(result.status === 'success') { 
      await Swal.fire({
        title: 'Berhasil!',
        text: 'Data telah berhasil disimpan.',
        icon: 'success',
        confirmButtonColor: '#2563eb',
        timer: 2000, 
        timerProgressBar: true
      });
      fetchData(); 
    }
    else throw new Error(result.message);

  } catch(e) { 
    Swal.fire({
      title: 'Gagal!',
      text: "Terjadi kesalahan: " + e.message,
      icon: 'error',
      confirmButtonColor: '#ef4444' 
    });
  } 
  finally { document.getElementById('loading').style.display = 'none'; }
}

async function approveBatch(batchId) { 
  const result = await Swal.fire({
    title: 'Approve Batch?',
    text: `Anda akan menyetujui batch ID: ${batchId}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#059669', 
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Ya, Approve!',
    cancelButtonText: 'Batal'
  });

  if(result.isConfirmed) {
    await postAction('approve', { batchId }); 
  }
}

async function syncXero(batchId) { 
  const result = await Swal.fire({
    title: 'Sync ke Xero?',
    text: `Data batch ${batchId} akan dikirim ke Xero.`,
    icon: 'info',
    showCancelButton: true,
    confirmButtonColor: '#4f46e5', 
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Ya, Sync Sekarang',
    cancelButtonText: 'Nanti Saja'
  });

  if(result.isConfirmed) {
    await postAction('syncXero', { batchId }); 
  }
}
</script>
</body>
</html>
